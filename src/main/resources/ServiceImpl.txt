package ${basePackage}.${ettNameLower}.service.impl;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.streaming.SXSSFWorkbook;
import com.monitorjbl.xlsx.StreamingReader;
import lombok.extern.log4j.Log4j2;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.sql.Types;
import java.util.*;

import ${basePackageImport}.core.util.CommonUtil;
import ${basePackageImport}.core.util.ExcelUtil;
import ${basePackageImport}.model.Constants;
import ${basePackageImport}.model.dto.catalog.CatalogDto;
import ${basePackageImport}.model.entity.${pckNameLower}.${ettFirstUpperCamel};
import ${basePackageImport}.model.entity.${pckNameLower}.${pckFirstUpperCamel};
import ${basePackageImport}.model.enumeration.${pckFirstUpperCamel}TypeEnum;
import ${basePackageImport}.model.dto.${pckNameLower}.Check${pckFirstUpperCamel}Dto;
import ${basePackage}.${ettNameLower}.integration.ChCatalogClient;
import ${basePackage}.${ettNameLower}.service.adapter.${pckFirstUpperCamel}CommonAdapter;

@Service
@Log4j2
public class ${ettFirstUpperCamel}ServiceImpl implements ${pckFirstUpperCamel}CommonAdapter {
#foreach($ppt in $ppts)
#set($codeEnum = $textUtils.wordsToSnakeUpper(${ppt.lineKey}).concat("_").concat($textUtils.wordsToSnakeUpper(${ppt.typeKey})).concat("_").concat($textUtils.wordsToSnakeUpper(${ppt.entityKey})))
#break
#end
    public static final int FIRST_ROW_NUM = 0;
#if($!{headerSize})

    public static final int LAST_ROW_NUM = ${headerSize};
#else

    public static final int LAST_ROW_NUM = 0;
#end
#if($!{lstHeaderString})

    static final String[] ${codeEnum}_HEADERS = {${lstHeaderString}};
#else

    static final String[] ${codeEnum}_HEADERS = {};
#end

    @Autowired
    private ChCatalogClient catalogClient;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public Check${pckFirstUpperCamel}Dto check${pckFirstUpperCamel}(${pckFirstUpperCamel} ${pckNameLower}) throws IOException {
        boolean errorStatus = false;
        int countErrorRow = 0;
        List<${ettFirstUpperCamel}> listBooks = new ArrayList<>();
        ByteArrayInputStream inputStream = new ByteArrayInputStream(${pckNameLower}.getData());
        // Get workbook
        Check${pckFirstUpperCamel}Dto<${ettFirstUpperCamel}> check${pckFirstUpperCamel}Dto;

        // Tạo một Workbook mới để chỉnh sửa và thêm cột mới
        try (Workbook originWorkbook = StreamingReader.builder()
                .rowCacheSize(100)
                .bufferSize(4096)
                .open(inputStream);
             SXSSFWorkbook modifiedWorkbook = new SXSSFWorkbook()
        ) {
            // Get sheet
            Sheet originSheet = originWorkbook.getSheetAt(0);
            Sheet modifiedSheet = modifiedWorkbook.createSheet(originSheet.getSheetName());

            // Get all rows
            Iterator<Row> originIterator = originSheet.iterator();
            boolean hasHeader = false;
            while (originIterator.hasNext()) {
                Row nextOriginRow = originIterator.next();
                Row modifiedRow = modifiedSheet.createRow(nextOriginRow.getRowNum());

                if (!hasHeader) {
                    for (int col = 0; col < ${codeEnum}_HEADERS.length; col++) {
                        Cell cell = modifiedRow.createCell(col);
                        cell.setCellValue(${codeEnum}_HEADERS[col]);
                    }
                }

                Cell errorCell = modifiedRow.createCell(LAST_ROW_NUM + 1, CellType.STRING);
                if (nextOriginRow.getRowNum() == 0) {
                    errorCell.setCellValue("Error");
                }

                if (nextOriginRow.getRowNum() == 0) {
                    continue;
                }

                boolean errorCellValueIsNull = false;
                ${ettFirstUpperCamel} book = new ${ettFirstUpperCamel}();
                for (int columnIndex = FIRST_ROW_NUM; columnIndex <= LAST_ROW_NUM; columnIndex++) {
                    Cell originCell = nextOriginRow.getCell(columnIndex);
                    Cell modifiedCell = modifiedRow.createCell(columnIndex);
                    String cellValue = ExcelUtil.getCellValue(originCell);

#set($setCase = 'F')
#foreach($header in $lstHeader)
#foreach($pptHd in $ppts)
#if($header == $pptHd.nameDisplay)
#set($setCase = 'S')
#break
#end
#end
#end
#if(${setCase} == 'F')
                    //TODO: không tìm thấy thông tin thích hợp trong excel
#else
                    switch (columnIndex) {
#foreach($header in $lstHeader)
#set($caseNum = ${foreach.index})
#foreach($pptHd in $ppts)
#if($header == $pptHd.nameDisplay && $pptHd.checkEmpty == 'TRUE')
                        case ${caseNum}:
                            if (cellValue != null) {
                                modifiedCell.setCellValue(originCell.getStringCellValue());
                                book.set$textUtils.wordsToCamelFirstUpper(${pptHd.nameProperty})(cellValue);
                            } else {
                                errorStatus = true;
                                errorCellValueIsNull = setErrorCellValue(errorCell, columnIndex, errorCellValueIsNull, Constants.ErrorMessageExcel.CAN_NOT_BE_EMPTY);
                            }
                            break;
#elseif($header == $pptHd.nameDisplay && $pptHd.isCatalog == 'TRUE')
                        case ${caseNum}:
                            if (cellValue != null) {
                                modifiedCell.setCellValue(originCell.getStringCellValue());

                                List<CatalogDto> lstTitle = catalogClient.findByLineTypeCode("", "", "");
                                String cellValueCatalog = lstTitle.stream().filter(c -> c.getLabel().equals(cellValue)).map(CatalogDto::getLabelCode).findFirst().orElse(null);
                                if (!CommonUtil.isNullOrEmpty(cellValueCatalog)) {
                                    book.set$textUtils.wordsToCamelFirstUpper(${pptHd.nameProperty})(cellValueCatalog);
                                } else {
                                    errorStatus = true;
                                    errorCellValueIsNull = setErrorCellValue(errorCell, columnIndex, errorCellValueIsNull, Constants.ErrorMessageExcel.INVALID_VALUE);
                                }
                            } else {
                                errorStatus = true;
                                errorCellValueIsNull = setErrorCellValue(errorCell, columnIndex, errorCellValueIsNull, Constants.ErrorMessageExcel.CAN_NOT_BE_EMPTY);
                            }
                            break;
#elseif($header == $pptHd.nameDisplay && $pptHd.type == 'Date')
                        case ${caseNum}:
                            if (cellValue != null) {
                                modifiedCell.setCellValue(originCell.getStringCellValue());
                                book.set$textUtils.wordsToCamelFirstUpper(${pptHd.nameProperty})(ExcelUtil.getCellDateValue(originCell));
#if($pptHd.checkEmpty == 'TRUE')
                            } else {
                                errorStatus = true;
                                errorCellValueIsNull = setErrorCellValue(errorCell, columnIndex, errorCellValueIsNull, Constants.ErrorMessageExcel.CAN_NOT_BE_EMPTY);
#end
                            }
                            break;
#end
#end
#end
                        default:
                            break;
                    }
#end
                }
                book.setId(UUID.randomUUID().toString().toLowerCase());
                book.setDocId(${pckNameLower}.getId());
                book.setStatus(${pckNameLower}.getStatus());
                book.setCreatedDate(${pckNameLower}.getCreatedDate());
                listBooks.add(book);

                if (errorCellValueIsNull) {
                    countErrorRow++;
                }
            }

            check${pckFirstUpperCamel}Dto = new Check${pckFirstUpperCamel}Dto<>();
            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
            modifiedWorkbook.write(outputStream);

            byte[] ${pckNameLower}Data = outputStream.toByteArray();
            // nếu không có cell nào lỗi thì xuất ra file gốc, ngược lại xuất ra file lỗi
            if (!errorStatus) {
                check${pckFirstUpperCamel}Dto.setData(document.getData());
            } else {
                check${pckFirstUpperCamel}Dto.setData(documentData);
            }
            check${pckFirstUpperCamel}Dto.setErrorStatus(errorStatus);
            if (countErrorRow > 0) {
                check${pckFirstUpperCamel}Dto.setErrorDescription(countErrorRow + " bản ghi lỗi");
            }
            check${pckFirstUpperCamel}Dto.setLstDocument(listBooks);

            inputStream.close();
        }
        return check${pckFirstUpperCamel}Dto;
    }

    public boolean setErrorCellValue(Cell errorCell, int errorCellIndex, boolean hasCellNull, String error) {
        if (!hasCellNull) {
            errorCell.setCellValue(error + " cột " + ExcelUtil.convertIndexToColumnName(errorCellIndex + 1));
        } else {
            String errorCellValue = errorCell.getStringCellValue();
            errorCell.setCellValue(errorCellValue + ", " + error + " cột " + ExcelUtil.convertIndexToColumnName(errorCellIndex + 1));
        }
        return true;
    }

#set($idRefCol = '')
#set($updateStatus = '')
#set($checkApprover = '')
#set($checkApprovedDate = '')
#foreach($ppt in $ppts)
#if($textUtils.wordsToLowerCase($ppt.refType) == ${pckNameLower})
#set($idRefCol = $textUtils.wordsToSnakeUpper($ppt.nameColumn))
#end
#if($textUtils.wordsToSnakeUpper($ppt.nameColumn) == 'STATUS')
#set($updateStatus = 'S')
#end
#if($textUtils.wordsToSnakeUpper($ppt.nameColumn) == 'APPROVER')
#set($checkApprover = 'S')
#end
#if($textUtils.wordsToSnakeUpper($ppt.nameColumn) == 'APPROVED_DATE')
#set($checkApprovedDate = 'S')
#end
#end
#if($!{idRefCol})
    @Override
    public boolean cleanAllByTestId(Long ${pckNameLower}Id) {
        if (${pckNameLower}Id != null) {
            String sql = "DELETE FROM NSLD_APP.${codeEnum} WHERE ${idRefCol} = ?";
            jdbcTemplate.update(sql, ${pckNameLower}Id);
            return true;
        }
        return false;
    }

#end
#if(${updateStatus} == 'S' && $!{idRefCol})
    @Override
    public boolean updateStatus(Long ${pckNameLower}Id, String status) {
        if (${pckNameLower}Id != null) {
            String sql = "UPDATE NSLD_APP.${codeEnum} SET STATUS = ? WHERE ${idRefCol} = ?";
            jdbcTemplate.update(sql, status, d${pckNameLower}Id);
            return true;
        }
        return false;
    }

#end
#if(${checkApprover} == 'S' && ${checkApprovedDate} == 'S' && $!{idRefCol})
    @Override
    public boolean updateApproveInfo(Long ${pckNameLower}Id, String approver, Date approvedDate) {
        if (documentId != null) {
            String sql = "UPDATE NSLD_APP.${codeEnum} SET APPROVER = ?, APPROVED_DATE = ? WHERE DOC_ID = ?";
            jdbcTemplate.update(sql, approver, approvedDate, ${pckNameLower}Id);
            return true;
        }
        return false;
    }

#end
    @Override
    public String getSupportService() {
        return DocumentTypeEnum.${codeEnum}.getCode();
    }
}
